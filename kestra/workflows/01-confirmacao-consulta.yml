# ============================================
# WORKFLOW: Confirma√ß√£o de Consulta
# ============================================
# Dispara quando agendamento √© criado
# Envia WhatsApp pedindo confirma√ß√£o
# ============================================

id: confirmacao-consulta
namespace: clinica
description: Envia mensagem de confirma√ß√£o de consulta via WhatsApp

labels:
  team: atendimento
  module: agenda
  priority: high

inputs:
  - id: agendamento_id
    type: STRING
    required: true
    description: ID do agendamento

  - id: paciente_telefone
    type: STRING
    required: true
    description: Telefone do paciente

  - id: paciente_nome
    type: STRING
    required: true
    description: Nome do paciente

  - id: medico_nome
    type: STRING
    required: true
    description: Nome do m√©dico

  - id: data
    type: STRING
    required: true
    description: Data da consulta (YYYY-MM-DD)

  - id: hora
    type: STRING
    required: true
    description: Hor√°rio da consulta (HH:MM)

  - id: clinica_id
    type: STRING
    required: true
    description: ID da cl√≠nica

tasks:
  # ----------------------------------------
  # 1. Formata data para exibi√ß√£o
  # ----------------------------------------
  - id: formatar_data
    type: io.kestra.plugin.scripts.python.Script
    runner: PROCESS
    script: |
      from datetime import datetime
      
      data_str = "{{ inputs.data }}"
      data = datetime.strptime(data_str, "%Y-%m-%d")
      
      dias_semana = ["Segunda", "Ter√ßa", "Quarta", "Quinta", "Sexta", "S√°bado", "Domingo"]
      meses = ["", "janeiro", "fevereiro", "mar√ßo", "abril", "maio", "junho", 
               "julho", "agosto", "setembro", "outubro", "novembro", "dezembro"]
      
      dia_semana = dias_semana[data.weekday()]
      data_formatada = f"{dia_semana}, {data.day} de {meses[data.month]}"
      
      print(f"::set-output name=data_formatada::{data_formatada}")

  # ----------------------------------------
  # 2. Envia WhatsApp via Evolution API
  # ----------------------------------------
  - id: enviar_whatsapp
    type: io.kestra.plugin.core.http.Request
    uri: "{{ secret('EVOLUTION_API_URL') }}/message/sendText/{{ secret('EVOLUTION_INSTANCE') }}"
    method: POST
    headers:
      apikey: "{{ secret('EVOLUTION_API_KEY') }}"
      Content-Type: application/json
    body: |
      {
        "number": "55{{ inputs.paciente_telefone }}",
        "text": "Ol√°, {{ inputs.paciente_nome }}! üëã\n\nConfirmamos sua consulta:\n\nüìÖ {{ outputs.formatar_data.vars.data_formatada }}\n‚è∞ Hor√°rio: {{ inputs.hora }}\nüë®‚Äç‚öïÔ∏è M√©dico: {{ inputs.medico_nome }}\n\nPara *confirmar*, responda SIM\nPara *cancelar*, responda CANCELAR\n\nEm caso de d√∫vidas, entre em contato conosco."
      }

  # ----------------------------------------
  # 3. Registra envio no banco
  # ----------------------------------------
  - id: registrar_envio
    type: io.kestra.plugin.core.http.Request
    uri: "{{ secret('API_URL') }}/v1/internal/mensagens"
    method: POST
    headers:
      Authorization: "Bearer {{ secret('API_INTERNAL_TOKEN') }}"
      Content-Type: application/json
    body: |
      {
        "clinica_id": "{{ inputs.clinica_id }}",
        "agendamento_id": "{{ inputs.agendamento_id }}",
        "paciente_telefone": "{{ inputs.paciente_telefone }}",
        "tipo": "confirmacao_consulta",
        "direcao": "enviada",
        "status": "enviada",
        "conteudo": "Confirma√ß√£o de consulta enviada",
        "message_id": "{{ outputs.enviar_whatsapp.body.key.id }}"
      }

  # ----------------------------------------
  # 4. Atualiza card do Kanban
  # ----------------------------------------
  - id: atualizar_card
    type: io.kestra.plugin.core.http.Request
    uri: "{{ secret('API_URL') }}/v1/internal/cards/by-agendamento/{{ inputs.agendamento_id }}/checklist/confirmacao_enviada"
    method: POST
    headers:
      Authorization: "Bearer {{ secret('API_INTERNAL_TOKEN') }}"
      Content-Type: application/json
    body: |
      {
        "concluido": true,
        "automatico": true
      }

errors:
  - id: notificar_erro
    type: io.kestra.plugin.core.http.Request
    uri: "{{ secret('API_URL') }}/v1/internal/alertas"
    method: POST
    headers:
      Authorization: "Bearer {{ secret('API_INTERNAL_TOKEN') }}"
      Content-Type: application/json
    body: |
      {
        "clinica_id": "{{ inputs.clinica_id }}",
        "tipo": "workflow_error",
        "titulo": "Erro ao enviar confirma√ß√£o",
        "mensagem": "Falha ao enviar WhatsApp para {{ inputs.paciente_nome }}",
        "referencia_tipo": "agendamento",
        "referencia_id": "{{ inputs.agendamento_id }}",
        "dados": {
          "workflow": "confirmacao-consulta",
          "erro": "{{ error.message }}"
        }
      }

triggers:
  # Pode ser disparado via API
  - id: webhook
    type: io.kestra.plugin.core.trigger.Webhook
    key: "confirmacao-consulta-trigger"
